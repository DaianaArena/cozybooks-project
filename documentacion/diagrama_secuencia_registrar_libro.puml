@startuml
title Diagrama de Secuencia - CU11: Registrar Libro

actor "Usuario" as Usuario
participant "MenuView" as MenuView
participant "LibroController" as LibroController
participant "LibroRepository" as LibroRepository
participant "AutorRepository" as AutorRepository
database "Database" as DB

Usuario -> MenuView : Seleccionar opción "Registrar Libro"
activate MenuView

MenuView -> LibroController : registrarLibro()
activate LibroController

LibroController -> Usuario : Solicitar datos del libro\n(título, ISBN, editorial, año, precio,\ngénero, stock, ID autor, tipo_libro,\n+ campos específicos según tipo)
activate Usuario

Usuario -> LibroController : Ingresar datos del libro
deactivate Usuario

' Validar que existe el autor
LibroController -> AutorRepository : obtenerPorId(idAutor)
activate AutorRepository

AutorRepository -> DB : SELECT FROM AUTOR WHERE id_autor = ?
activate DB
DB --> AutorRepository : autor o null
deactivate DB

alt Autor no encontrado
    AutorRepository --> LibroController : null
    deactivate AutorRepository
    LibroController -> Usuario : Error: "No se encontró el autor con ID: X"
    activate Usuario
    Usuario -> LibroController : Continuar
    deactivate Usuario
    LibroController --> MenuView : Error
    deactivate LibroController
    MenuView --> Usuario : Mensaje de error
    deactivate MenuView
else Autor encontrado
    AutorRepository --> LibroController : autor
    deactivate AutorRepository
    
    ' Validar datos del libro
    LibroController -> LibroController : validarDatosLibro(datos)\n- título no vacío\n- precio > 0\n- stock >= 0\n- ISBN único (si se proporciona)\n- tipo_libro obligatorio
    
    ' Insertar en tabla LIBRO con todos los campos
    LibroController -> LibroRepository : registrar(libro)
    activate LibroRepository
    
    LibroRepository -> DB : INSERT INTO LIBRO\n(campos comunes + campos específicos según tipo)
    activate DB
    DB --> LibroRepository : id_libro generado
    deactivate DB
    
    LibroRepository --> LibroController : libro con ID asignado
    deactivate LibroRepository
    
    LibroController -> Usuario : Libro registrado exitosamente\n(ID: id_libro)
    activate Usuario
    Usuario -> LibroController : Continuar
    deactivate Usuario
    
    LibroController --> MenuView : Éxito
    deactivate LibroController
    
    MenuView --> Usuario : Mensaje de éxito
    deactivate MenuView
end

@enduml

